<%inherit file="/base.html" />
<%def name="sel(name,lst,val,attr='')">
<select name='${name}' ${attr}>
% for st in lst:
<option value='${st}' \
% if st==val:
selected=1 \
% endif
>${st}</option>
% endfor
</select>\
</%def>
<%def name="taskmenu()">
<h2>Task ${task['story']}</h2>
[ <a href="${upr}/s/${task['story']}">summary</a> ::
<a href="${upr}/s/${task['story']}/log"
   accesskey='i'>h<b>i</b>story</a> :: 
<a href="${upr}/s/${task['story']}/j"
   accesskey='j'><b>j</b>ournal</a> ]

:: <a href="${upr}/s/new/${task['story']}" accesskey='s'><b>s</b>ubtask</a> :: \
% if '/' in task['story']:
<a href="${upr}/s/${"/".join(task['story'].split('/')[0:-1])}" accesskey="u">one <b>u</b>p</a> :: \
% endif
<hr />
</%def>
<%def name="content()">
${taskmenu()}
% if msg:
<div class='msg'>${msg}</div>
% endif
<small>created ${task['created at']}</small>
<form method='post'>
% if task.get('under'):
<h4>under ${task.get('under')}</h4>
<input type='hidden' name='under' value="${task.get('under')}" />
% endif
<input type='hidden' name='id' value="${task['story']}" />
<dl>
% for pid,psum in parents:
<a title="${pid}" href="${upr}/s/${pid}">${psum}</a> &#8250;
% endfor
<dt>Summary</dt>
<dd><input id='summary' class='summary' type='text' name="summary" value="${task['summary']|h}" /></dd>

<dt>Tags</dt>
<dd>
  % for tag in task['tags']:
  <input type='checkbox' name="tag-${tag|h}" checked=1 value=1 /> <a href="${upr}/tag/${tag}">${tag}</a> ; 
  % endfor
  add tag(s): <input type='text' name='tag-new' value="" />
</dd>

<dt>s<b>t</b>atus</dt>
<dd>
${self.sel('status',statuses,task['status'],attr='accesskey="t"')}
</dd>
<dt>metastates</dt>
<dd>
% for k,v in metastates.items():
${k}: 
${self.metastate_sel(task['story'],k,v.get('value'),colors,possible_metastates,overrides,metastates)}
<br />
% endfor
<dt>assignee</dt>
<dd><a href="${upr}/assignments/${task['assigned to']}">${task['assigned to']}</a> ;
change to ${self.sel('assignee',participants,task['assigned to'])}
</se
</dd>

<dt>creator</dt>
<dd><a href="${upr}/assignments/${task['created by']}">${task['created by']}</a></dd>

% if task.get('links'):
<dt>links</dt>
<dd>
<ul>
  % for li in task['links']:
  <li>  <input type='checkbox' name="link-${li['anchor']|h}" checked=1 value="${li['url']|h}" />  <a href="${li['url']}">${li['anchor']}</a></li>
  % endfor
</ul>
</dd>
% endif

% if task.get('informed'):
<dt>informed</dt>
<dd>
<ul>
% for inf in task['informed']:
<li><input type="checkbox" name="informed-${inf|h}" checked=1 value=1 /><a href="${upr}/assignments/${inf}">${inf}</a></li>
% endfor
</ul>
</dd>
% endif

% if task.get('repobranch'):
<dt>repo/branch</dt>
<dd>
<ul>
% for br in task.get('repobranch'):
<% r,b = br.split('/') %>
<li><input type='checkbox' name="repobranch-${br|h}" value="1" checked=1 /><a href="${gwu}?p=${r}.git;a=shortlog;h=refs/heads/${b}">${r}/${b}</a></li>
% endfor
</ul>
</dd>
% endif

</dl>


<h3>Edit</h3> <a id='showtog' style='float:right' href="#">graphical repr</a>

add : link. descr: <input type='text' name='link-new-anchor' /> url: <input type='text' name='link-new-url' />
informed: 
${sel('informed-new',['']+participants,'')}
repo/branch ${sel('repobranch-new-repo',repos,'')}/<input type='text' name='repobranch-new-branch' />
<textarea id='content' class='content' name='unstructured'>${task['unstructured'].decode('utf-8')}</textarea>
<div id='contentwrapper'>
</div>
% if task['id']:
<input type='submit' value='Update' accesskey='a' />
% else:
<input name='create' type='submit' value='Create' accesskey='a' />
% endif
</form>

% if len(children):
<h3>Sub tasks</h3>
${self.list_tasks(children)}
% endif

% if task.get('person_hours'):
<h3>Time tracking</h3>
<table>
<thead>
<tr>
  <th>person</th>
  <td>last tracked</th>
  <td>hours</th>
</tr>
</thead>
<tbody>
% for ph in task['person_hours']:
<tr>
<td>${ph[0]}</td>
<td>${ph[1]['last_tracked']}</td>
<td class='ralign'>${"%4.1f"%ph[1]['hours']}</td>
</tr>
% endfor
</tbody>
</table>
% endif

## <h3>Render</h3>
## <iframe class='rndr' src=""></iframe>

<script type='text/javascript'>
window.onload = function() {
document.getElementById('summary').focus();
document.getElementById('showtog').onclick = function(ev) {
    var togel = document.getElementById('showtog');
    var contel = document.getElementById('content');
    var wrapel = document.getElementById('contentwrapper');
    if (togel.innerHTML=='graphical repr')
    {
	var x = new XMLHttpRequest();
	x.onreadystatechange = function() {
            if(x.readyState == 4){
		wrapel.innerHTML=x.response;
		wrapel.style.display='';
		contel.style.display='none';
            }
	}
	x.open("GET",location.href.replace('/s/','/repr/'),true);
	x.send(null);

	togel.innerHTML='edit';
    }
    else
    {
	wrapel.style.display='none';
	contel.style.display='';
	togel.innerHTML='graphical repr';
    }
    ev.preventDefault();
}}
</script>
</%def>
