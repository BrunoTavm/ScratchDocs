<%inherit file="/base.html" />
<%def name="sel(name,lst,val,attr='')">
<select class="form-control" name='${name}' ${attr}>
% for st in lst:
<option value='${st}' \
% if st==val:
selected=1 \
% endif
>${st}</option>
% endfor
</select>\
</%def>
<%def name="taskmenu()">
<h2>Task ${task['story']}</h2>
<ul class="nav nav-pills">
    <li><a href="${upr}/${task['story']}" accesskey="m">su<b>m</b>mary</a></li>
    <li><a href="${upr}/${task['story']}/log" accesskey='i'>h<b>i</b>story</a></li>
    <li><a href="${upr}/${task['story']}/j" accesskey='j'><b>j</b>ournal</a></li>
    <li class="divider-vertical"></li>
    <li><a href="${upr}/s/new/${task['story']}" accesskey='s'><b>s</b>ubtask</a></li>
    % if '/' in task['story']:
    <li><a href="${upr}/${"/".join(task['story'].split('/')[0:-1])}" accesskey="u">one <b>u</b>p</a></li>
    % endif
</ul>

<hr />
</%def>
<%def name="content()">
${taskmenu()}
% if msg:
<div class='msg'>${msg}</div>
% endif
<small>created ${task['created at']}</small>
<form method='post' class="form-horizontal">
% if task['id']:
    <input class="btn btn-primary  pull-right" type='submit' value='Update' accesskey='a' />
% else:
    <input class="btn btn-primary  pull-right" type='submit' value='Create' accesskey='a' name='create'/>
% endif

    % if task.get('under'):
    <h4>under ${task.get('under')}</h4>
    <input type='hidden' name='under' value="${task.get('under')}" />
    % endif
    <input type='hidden' name='id' value="${task['story']}" />
    % for pid,psum in parents:
    <a title="${pid}" href="${upr}/${pid}">${psum}</a> &#8250;
    % endfor

    <div class="control-group">
        <label for="summary" class="control-label">Summary</label>
        <div class="controls">
            <input id="summary" class="form-control span12" type="text" name="summary" value="${task['summary']|h}" />
        </div>
    </div>

    <div class="control-group">
        <label class="control-label">Tags</label>
        <div class="controls form-inline">
            % for tag in task['tags']:
            <label class="checkbox">
                <input type='checkbox' name="tag-${tag|h}" checked=1 value=1 />
                <a href="${upr}/tag/${tag}">${tag}</a> ;
            </label>
            % endfor
            <input type='text' name='tag-new' value="" id="inp-add-tag" placeholder="add tag(s)"/>
        </div>
    </div>

    <div class="control-group">
        <label for="sel-status" class="control-label">S<b>t</b>atus</label>
        <div class="controls">
            ${self.sel('status',statuses,task['status'],attr='accesskey="t" id="sel-status"')}
        </div>
    </div>

    <div class="control-group">
        <label class="control-label">Metastates</label>
        <div class="controls">
        % for k,v in metastates.items():
        ${k}: 
        ${self.metastate_sel(task['story'],k,v.get('value'),colors,possible_metastates,overrides,metastates)}
        <br />
        % endfor
        </div>
    </div>

    <div class="control-group">
        <label class="control-label">Assignee</label>
        <div class="controls">
            <a href="${upr}/assignments/${task['assigned to']}">${task['assigned to']}</a> &nbsp;
            change to ${self.sel('assignee',participants,task['assigned to'])}
        </div>
    </div>

    <div class="control-group">
        <label class="control-label">Creator</label>
        <div class="controls">
            <a href="${upr}/assignments/${task['created by']}">${task['created by']}</a>
        </div>
    </div>

% if task.get('links'):
    <div class="control-group">
        <label class="control-label">Links</label>
        <div class="controls">
            <ul class="unstyled">
                % for li in task['links']:
                <li>  <input type='checkbox' name="link-${li['anchor']|h}" checked=1 value="${li['url']|h}" />  <a href="${li['url']}">${li['anchor']}</a></li>
                % endfor
            </ul>
        </div>
    </div>
% endif

% if task.get('informed'):
    <div class="control-group">
        <label class="control-label">Informed</label>
        <div class="controls">
            <ul class="unstyled">
                % for inf in task['informed']:
                <li><input type="checkbox" name="informed-${inf|h}" checked=1 value=1 /><a href="${upr}/assignments/${inf}">${inf}</a></li>
                % endfor
            </ul>
        </div>
    </div>
% endif

% if task.get('repobranch'):
    <div class="control-group">
        <label class="control-label">Repo/Branch</label>
        <div class="controls">
            <table class="table table-hover">
                <thead><tr>
                    <th>del</th>
                    <th>repo/branch</th>
                    % for db in diff_branches:
                    <th>${db}</th>
                    % endfor
                </tr></thead>
                % for br in task.get('repobranch'):
                <tr>
                    <% r,b = br.split('/') %>
                    <td><input type='checkbox' name="repobranch-${br|h}" value="1" checked=1 /></td>
                    <td><a href="${gwu}?p=${r}.git;a=shortlog;h=refs/heads/${b}">${r}/${b}</a></td>
                    % for db in diff_branches:
                    <td><a href="${gwu}?p=${r}.git;a=commitdiff;h=refs/heads/${b};hp=${db}">${db}</a></td>
                    % endfor
                </tr>
                % endfor
            </table>
        </div>
    </div>

    <div class="control-group">
        <label class="control-label">Automerge</label>
        <div class="controls">
<pre>
<% defr = task.get('repobranch')[0].split('/')[1] %>\
./automerge.py \
--from=${defr} \
--purge --linters \
--message='#${task['id']}: automerge.' \
${' '.join([(rb.split('/')[1]!=defr and rb or rb.split('/')[0]) for rb in task.get('repobranch')])} \
</pre>
        </div>
    </div>
% endif

    <h3>Edit</h3> <a id='showtog' style='float:right' href="#">graphical repr</a>

    add : link. descr: <input type='text' name='link-new-anchor' /> url: <input type='text' name='link-new-url' />
    informed: 
    ${sel('informed-new',['']+participants,'')}
    repo/branch ${sel('repobranch-new-repo',repos,'')}/<input type='text' name='repobranch-new-branch' />
    <textarea id='content' class='content' name='unstructured'>${task['unstructured'].decode('utf-8')}</textarea>
    <div id='contentwrapper'>
    </div>
    % if task['id']:
        <input class="btn btn-primary pull-right" type='submit' value='Update' accesskey='a' />
    % else:
        <input class="btn btn-primary pull-right" type='submit' value='Create' accesskey='a' name='create'/>
    % endif
</form>

% if len(children):
<h3>Sub tasks</h3>
${self.list_tasks(children)}
% endif

% if task.get('person_hours'):
<h3>Time tracking</h3>
<table class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
          <th>person</th>
          <td>last tracked</th>
          <td>hours</th>
        </tr>
    </thead>
    <tbody>
    % for ph in task['person_hours']:
        <tr>
            <td>${ph[0]}</td>
            <td>${ph[1]['last_tracked']}</td>
            <td class='ralign'>${"%4.1f"%ph[1]['hours']}</td>
        </tr>
    % endfor
    </tbody>
</table>
% endif

## <h3>Render</h3>
## <iframe class='rndr' src=""></iframe>

<script type='text/javascript'>
window.onload = function() {
document.getElementById('summary').focus();
document.getElementById('showtog').onclick = function(ev) {
    var togel = document.getElementById('showtog');
    var contel = document.getElementById('content');
    var wrapel = document.getElementById('contentwrapper');
    if (togel.innerHTML=='graphical repr')
    {
	var x = new XMLHttpRequest();
	x.onreadystatechange = function() {
            if(x.readyState == 4){
		wrapel.innerHTML=x.response;
		wrapel.style.display='';
		contel.style.display='none';
            }
	}
	x.open("GET",location.href.replace(location.pathname,'/repr'+location.pathname),true);
	x.send(null);

	togel.innerHTML='edit';
    }
    else
    {
	wrapel.style.display='none';
	contel.style.display='';
	togel.innerHTML='graphical repr';
    }
    ev.preventDefault();
}}
</script>
</%def>
